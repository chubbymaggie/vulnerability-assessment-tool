{{- if .Values.benchmark -}}
apiVersion: batch/v1
kind: Job

metadata:
  name: bench-pgbench-slave
  namespace: {{ .Values.global.namespace }}
  labels:
    app.kubernetes.io/name: pgbench
    app.kubernetes.io/instance: slave
    app.kubernetes.io/part-of: {{ .Values.global.projectName }}
    {{ .Values.global.projectName }}/release-name: {{ .Release.Name }}

spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: pgbench
        app.kubernetes.io/instance: slave
        app.kubernetes.io/part-of: {{ .Values.global.projectName }}
        {{ .Values.global.projectName }}/release-name: {{ .Release.Name }}
    spec:
      restartPolicy: Never
      containers:
        - name: bench-pgbench-slave
          image: postgres:11.5-alpine
          imagePullPolicy: "IfNotPresent"
          command:
            - sh
            - -c
            - |
              #!/bin/sh
              export PGPASSWORD={{ .Values.global.dbCredentials.postgres_password }}
              pgbench -c 80 -j 8 -U {{ .Values.global.dbCredentials.postgres_user }} \
                      -f /bench.sql -r -n -T 600 -h {{ .Release.Name }}-db-slave \
                      -p 5432 {{ .Values.global.dbCredentials.postgres_db }}

          volumeMounts:
          - name: bench-pgbench-sql
            mountPath: /bench.sql
            subPath: bench.sql

      volumes:
      - name: bench-pgbench-sql
        configMap:
          name: bench-pgbench-sql
{{- end -}}
